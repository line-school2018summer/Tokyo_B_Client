
## 2018/08/10

## プロジェクトの進め方
+ 議事録はline-school2018summer/Tokyo_B_Client/Minutesに記録
+ 進捗，バグ，思ったこと，なんでもSlackで報告しあう．
+ スケジュール：[Google spreadsheet](https://docs.google.com/spreadsheets/d/1ArUzXXyipl8atcFYRJ_uwFQcKMf-7VYzmrO3rJgKhJI/edit#gid=872762068)
+ Tokyo_B_Clientのissueに各自行なったことを書く．

### 各自のスキルセット
+ 永田
  + 言語
    C， C++， Julia， Ruby, Python, HTML, CSS
  + 開発経験
    Webアプリ，　flaskを利用．

+ 鈴木
  + 言語
    Python, C++, XML, C, Ruby, R
  + 開発経験
   機械学習，主に強化学習

+ 滝口
  + 言語
Python, C#, C, C++, java
  + 開発経験
    機械学習，主に強化学習，Unity，

## 開発目標

#### 最初にやること
 + ログイン
 + 複数クライアント / 個別ユーザー間のメッセージ送受信
 + データ永続化
 + 非同期メッセージ
#### 次にやること
 + グループ機能
 + わかりやすく利用しやすいUIの設計
#### 最後にやること
 + プッシュ通知
 + スタンプ・画像送受信
 + フレンド機能
 + プラスアルファの独自の機能
  + chat botなど
   
   
## アプリケーションの仕様

### 言語仕様
+ Server
  + 言語
    Python（Framework： flask）
+ Client
  +言語
    Kotlon(IDE: Android Studio)
  + Android Version
    4.1
  + デザイン
    LINEっぽいの
    
### DB仕様
Data base name :: line_db

User.table :: ユーザーの情報
+ id
+ name
+ password
+ friend.table_id

friend.table　:: ユーザー間の関係を記述
+ id
+ friend_id
+ talk.table

talk.table　:: トークの内容を記述
+ id
+ content

### JSONの仕様
~~~
# / [get]
---
### GET
```
{"error": 0,
"content": {
    "message": "/[get]"
    }
}
```
# /register [get / post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/register[get]"
    }
}
```
### POST

#### request
```
{"target": "/register",
"authenticated": <authenticated>,
"user_id": <user_id>,
"name": <name>,
"password": <password>,
"password_confirm": <password>
}
```
#### response
* エラー有りの場合
    * すでにログインしている状態での/registerへのpostは認められません。
    * 既存アカウントに重複するような"user_id"は使用できません。
    * 3文字以下、13文字以上、英数字以外の"user_id"は認められません。
    * 0文字、もしくは32文字以上の"name"は認められません。
    * 5文字以下、13文字以上、英数字以外の"password"は認められません。
    * "password"と"password_confirm"は等しくなければいけません。
```
{"error": 1,
"content": {
    "authenticated": <0 or 1>,
    "exist_id": <0 or 1>,
    "bad_id": <0 or 1>,
    "bad_name": <0 or 1>,
    "bad_password": <0 or 1>,
    "password_confirm_does_not_match": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "logged_id": <id>
    "logged_user_id": <user_id>,
    "logged_pass" <password>,
    "token": <token>,
    "message": "successful registration"
    }
}
```
# /login [get / post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/login[get]"
    }
}
```
### POST
#### request
```
{"target": "/login", 
"authenticated": <authenticated>,
"user_id": <user_id>,
"password": <password>
```
#### response
* エラー有りの場合 
    * すでにログインしている状態での/registerへのpostは認められません。
    * 存在している"user_id"でなければいけません。
    * "user_id"が存在していた場合、"password"が合致していなければいけません。
    * (missing_id が 1 の時、invalid_password は自動的に 0 になるので、両者が常に同じ結果になることはありえません。)
```
{"error": 1, 
"content": {
    "authenticated": <0 or 1>,
    "missing_id": <0 or 1>,
    "invalid_password": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0, 
"content": {
    "logged_id": <id>
    "logged_user_id": <user_id>,
    "logged_pass" <password>,
    "token": <token>,
    "message": "logged in successfully"
    }
}
```
# /logout [get]
---
### GET
```
{"error": 0,
"content": {
    "message": "/logout[get]"
    }
}
```
### POST
#### request
```
{"target": "/logout", 
"authenticated": <authenticated>,
"id": <id>,
"token": <token>
```
#### response
* エラー有りの場合
    * ログインしていない状態での/logoutへのpostは認められません。
    * 合致しない"user_id", "token"でのpostは認められません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "message": "logged out successfully"
    }
}
```
# /account_modify [get / post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/account_modify[get]"
    }
}
```
### POST
#### request
"modify"内は変更先の情報を入力してください。空白は変更なしと捉えます。
```
{"target": "/account_modify",
"authenticated": <authenticated>,
"id": <user_id>,
"password": <password>,
"modify": {
    "user_id": <modify_id>,
    "name": <modify_name>,
    "password": <modify_password>,
    "password_confirm": <modify_password>
},
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/account_modifyへのpostは認められません。
    * 存在しない"user_id", "password"でのpostは認められません。
    * 既存の他のアカウントに重複するような"modify"-"user_id"は使用できません。
    * 3文字以下、13文字以上、英数字以外の"modify"-"user_id"は認められません。
    * 0文字、もしくは32文字以上の"modify"-"name"は認められません。
    * 5文字以下、13文字以上、英数字以外の"modift"-"password"は認められません。
    * "modify"-"password"と"modify"-"password_confirm"は等しくなければいけません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "exist_id": <0 or 1>,
    "bad_id": <0 or 1>,
    "bad_name": <0 or 1>,
    "bad_password": <0 or 1>,
    "password_confirm_does_not_match": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "new_id": <user_id>,
    "new_name": <name>,
    "message": "modified successfully"
    }
}
```
# /add_friend [get / post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/add_friend[get]"
    }
}
```
### POST
* "use_id"が1の場合、"User.id"で走査を行います。そうでない場合、"User.user_id"で走査を行います。
#### request
```
{"target": "/add_friend",
"authenticated": <authenticated>,
"use_id": <0 or 1>
"id": <id>,
"token": <token>,
"target_id": <target_user_id>
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/add_friendへのpostは認められません。
    * 合致しない"user_id", "token"でのpostは認められません。
    * "terget_id"には、既存で、かつ、post元のユーザーとは異なるユーザーに合致する"user_id"のみ認められます。
    * 自分自身を"target_id"に指定することはできません。
    * すでに追加しているユーザーは重複で追加できません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "unexist_id": <0 or 1>,
    "self_adding": <0 or 1>,
    "already_friend": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "message": "added successfully"
    }
}
```

# /remove_friend [get / post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/remove_friend[get]"
    }
}
```
### POST
* "use_id"が1の場合、"User.id"で走査を行います。そうでない場合、"User.user_id"で走査を行います。
#### request
```
{"target": "/remove_friend",
"authenticated": <authenticated>,
"use_id": <0 or 1>
"id": <id>,
"token": <token>,
"target_id": <target_user_id>
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/add_friendへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
    * 自分自身を"target_id"に指定することはできません。
    * "target_id"には、既存で、かつ、post元のユーザーとは異なるユーザーに合致する"user_id"のみ認められます。
    * friendに追加していないユーザーを"target_id"にすることはできません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>
    "unexist_id": <0 or 1>,
    "self_removing": <0 or 1>,
    "already_stranger": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "message": "removed successfully"
    }
}
```

# /friends_list [get / post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/friends_list[get]"
    }
}
```
### POST
#### request
```
{"target": "/friends_list",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/friend_listへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "message": "friends_list",
    "friends":{
        <id>: {"user_id": <str(user_id)>, "name": <str(name)>},
        <id>: {"user_id": <str(user_id)>, "name": <str(name)>},
        <id>: {"user_id": <str(user_id)>, "name": <str(name)>},
        ...
        }
    }
}
```

# /chat/personal/send [get, post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/chat/personal/send[get]"
    }
}
```
### POST
#### request
```
{"target": "/chat/personal/send",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>,
"content": {
    "talk_id": <talk_id>,  # 未だ存在しない場合、空文字
    "target": <id>,
    "text": <text>
    }
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/chat/personalへのpostは認められません。
    * 合致しない"user_id", "token"でのpostは認められません。
    * 合致しない"content"-"talk_id"でのpostは認められません。
    * 存在しない"content"-"user_id"へのpostは認められません。
    * 1024文字以上の"content"-"text"は認められません。
    * 空白、改行を除いたとき 0文字の"content"-"text"は認められません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "invalid_talk_id": <0 or 1>,
    "missing_target": <0 or 1>,
    "too_long_text": <0 or 1>,
    "meaningless_text": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "talk_id": <talk_id>,
    "message": "sent successfully"
    }
}
```

# /chat/group/send [get, post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/chat/group/send[get]"
    }
}
```
### POST
#### request
```
{"target": "/chat/group/send",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>,
"content": {
    "talk_id": <talk_id>,
    "text": <text>
    }
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/chat/personalへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
    * 存在しない"content"-"talk_id"でのpostは認められません。
    * 1024文字以上の"content"-"text"は認められません。
    * 空白、改行を除いたとき 0文字の"content"-"text"は認められません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "invalid_talk_id": <0 or 1>,
    "too_long_text": <0 or 1>,
    "meaningless_text": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "talk_id": <talk_id>,
    "message": "sent successfully"
    }
}
```

# /chat/get [get, post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/chat/get[get]"
    }
}
```
### POST
#### request
```
{"target": "/chat/get",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>,
"content": {
    "talk_all_need": <0 or 1>
    "talk_his": {
            {<talk_id>: <latest_content_id>},
            {<talk_id>: <latest_content_id>},
            {<talk_id>: <latest_content_id>},
            ...
        }
    }
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/chat/getへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
    * 存在しない"content"-"talk_id"は認められません。
    * これは負荷がかかる動作なので、"not_authenticated"か"invalid_verify"の内1つ以上が1の場合、"talk"の走査を行うことなくreturnされます。これにより、"invalid_talk_id"と"not_authenticated"もしくは"invalid_verify"の内少なくとも片方が共に1になることはあり得ません。(` "invalid_talk_id" and ("not_authenticated" or "invalid_verify")`は常にFalseであるということです。)
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "invalid_talk_id": <0 or 1>
    }
}
```
* エラーなしの場合
    * "content"-"talk_all_need"が1の場合、"content"-"talk_his"に含まれていないtalkの情報も返します。(外部からの新しいトークグループ作成に対応できるのはこちらのみです。)
    * "content"-"talk_all_need"が1の場合、"content"-"talk_his"に含まれているtalkの情報のみ返します(既存の一部のトークのみ更新したい場合便利です。トーク画面中などに用いると負荷を軽減させられるでしょう。)
```
{"error": 0,
"content": {
    "talk": {
        <talk_id>: {
            "name": <talk_group_name>,
            "new": {
                {<user_id>, <user_name>, <content>, <content_id>},
                {<user_id>, <user_name>, <content>, <content_id>},
                {<user_id>, <user_name>, <content>, <content_id>},
                ...
                }
            }
        },
        <talk_id>: {
            "name": <talk_group_name>,
            "new": {
                {<user_id>, <user_name>, <content>, <content_id>},
                {<user_id>, <user_name>, <content>, <content_id>},
                {<user_id>, <user_name>, <content>, <content_id>},
                ...
                }
            },
        ...
        },
        "message": "success"
    }
}
```

# /chat/join/self [get, post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/chat/join/self[get]"
    }
}
```
### POST
#### request
```
{"target": "/chat/join/self",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>,
"content": {
    "target_group": <group_id>
    }
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/chat/join/selfへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
    * 存在しない"content"-"target_group"は認められません。
    * 個人チャットへ侵入することはできません(/chat/personal/sendをもちいて作成してください。)
    * すでに参加しているgroupをtargetには指定できません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "invalid_talk_id": <0 or 1>,
    "personal_chat": <0 or 1>,
    "already_joined": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "message": "seccess"
    }
}
```
# /chat/join/other [get, post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/chat/join/other[get]"
    }
}
```
### POST
#### request
* "content"-"use_id"が1の場合、targetユーザの特定にはUser.idを用います。そうでない場合、User.user_idを用います。
```
{"target": "/chat/join/self",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>,
"content": {
    "use_id": <0 or 1>,
    "target_user_id": <user_id>,
    "target_group": <group_id>
    }
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/chat/join/otherへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
    * 存在しない"content"-"target_user_id"は認められません。
    * 存在しない"content"-"target_group"は認められません。
    * "content"-"target_group"にはpost元のユーザが参加していなければなりません。
    * 個人チャットへ侵入させることはできません(/chat/geiup/makeをもちいて作成してください。)
    * すでにターゲットユーザが参加しているgroupを"content"-"target_group"には指定できません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "invalid_user_id": <0 or 1>,
    "invalid_talk_id": <0 or 1>,
    "personal_chat": <0 or 1>,
    "user_not_joined": <0 or 1>,
    "already_joined": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
"content": {
    "message": "seccess"
    }
}
```

# /friend/search [get, post]
---
### GET
```
{"error": 0,
"content": {
    "message": "/friend/search[get]"
    }
}
```
### POST
#### request
* "content"-"use_id"が1の場合、targetユーザの特定にはUser.idを用います。そうでない場合、User.user_idを用います。
```
{"target": "/chat/join/self",
"authenticated": <authenticated>,
"id": <id>,
"token": <token>,
"content": {
    "use_id": <0 or 1>,
    "target_user_id": <user_id>
    }
}
```
#### response
* エラー有りの場合
    * ログインしていない状態での/chat/join/otherへのpostは認められません。
    * 合致しない"id", "token"でのpostは認められません。
    * 存在しない"content"-"target_user_id"は認められません。
```
{"error": 1,
"content": {
    "not_authenticated": <0 or 1>,
    "invalid_verify": <0 or 1>,
    "invalid_user_id": <0 or 1>
    }
}
```
* エラーなしの場合
```
{"error": 0,
    "content": {
        "id": <id>,
        "user_id": <user_id>,
        "name": <name>
    }
}
```
~~~

### Server-Client間の通信仕様
Client:
+ Data_sent
+ Data_get
  + １秒に１回サーバーを確認？
+ Initialize

Server:
+ SQLData exchange

## 完了したタスク
- [ ] .
- [x] .

## 8/10~8/16の期間で行うタスク
+ 永田
  - [ ] flaskでServerを構築
  - [ ] サーバー側の処理
  - [x] アカウント登録

+ 鈴木
  - [ ] Kotlin+Android Studioでアプリのフレームを構築
+ 滝口
  - [ ] SQLを構築

+ 終わり次第順次以下のタスクに取り掛かる
  - [ ] ログイン
  - [ ] 複数クライアント / 個別ユーザー間のメッセージ送受信
  - [ ] データ永続化
  - [ ] 非同期メッセージ


## 次回以降に決めたいこと
+ 問題があった点の洗い出し
+ 次週に取り組むタスク
+ UI/UX仕様決定
+ データのやりとりの詳細
  + JSONの仕様
  + DBの構造決定

